<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>stream room</title>
    <link rel="stylesheet" type="text/css" href="/css/stream-rooms.css">
</head>
<body>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<form method="post" action="/returnedToTheMenu">
    <input type="submit" id="returnedButton" value="returned to the menu"/>
</form>

<form method="post" id="watchGame" action="/watchGame">
    <input type="text" name="room" id="room"  hidden/>
</form>

<form method="post" id = "playGameForm" action="/playGame">
</form>

<table id="games"></table>

<script>
    let tgParam = window.Telegram.WebApp;
    let request = new XMLHttpRequest();
    let table = document.getElementById("games");
    let thead = document.createElement('thead');
    let tbody = document.createElement('tbody');

    table.appendChild(thead);
    table.appendChild(tbody);

    let row_heading = document.createElement("tr");
    let heading_1 = document.createElement("th");
    let heading_2 = document.createElement("th");
    heading_1.innerHTML = "Games:";
    heading_2.innerHTML = "";

    row_heading.appendChild(heading_1);
    row_heading.appendChild(heading_2);

    thead.appendChild(row_heading);

    request.open("POST", "/getGames", true);
    request.setRequestHeader("Content-Type", "application/json");
    request.addEventListener("load", function () {
        let games = JSON.parse(request.response);
        for(let i =0; i < games.length; i++){
            if(games[i].secondPlayer !== null){
                let row_dara = document.createElement('tr');
                let watchGame = document.createElement('td');
                let button = document.createElement('button');
                button.innerHTML = games[i].firstPlayer.first_name + " vs " + games[i].secondPlayer.first_name;
                button.addEventListener("click", () => {
                    let form = document.getElementById("watchGame");
                    let value = document.getElementById("room");
                    localStorage.setItem("Stream", i.toString());
                    value.value = i;
                    form.submit();
                })
                watchGame.appendChild(button);
                row_dara.appendChild(watchGame);
                tbody.appendChild(row_dara);
            }
        }
    });
    request.send();

    let form = document.getElementById("playGameForm")
    let MainButton = tgParam.MainButton;
    MainButton.text = "Play in Chess";
    MainButton.show();

    MainButton.onClick(function (){
        MainButton.hide();
        form.submit();
    })


</script>
</body>
</html>